!function(a,b,c){function x(){a(".fsComposeMessagePostSpan").is(":visible")?(a(".fsComposeMessagePostSpan").fadeToggle(),a("#triggerNewMsg").html("New Message"),a(".fsSocialPostMessage").each(function(){a(this).val("")}),a(".fsSocialPostSelectedRecipient").each(function(){a(this).remove()}),a(".fsSocialPostToPlaceholder").each(function(){a(this).show()}),a(".fsSocialPostAttachFile").each(function(){a(this).socialAttachFile("clear")}),a("#composeMsgResults").html('<ul><li id="moreRslts"><img src="images/loadingbar.gif"></li></ul>'),a(".fsSocialPostRecipientPicker").each(function(){a(this).is(":visible")&&(F(),a("#composeMsgSearch").val(""))})):(a(".fsComposeMessagePostSpan").fadeToggle(),a("#triggerNewMsg").html("Cancel"))}function y(b){var c=a(b.target),d=c.parents("#fsComposeMessagePostForm"),e=d.find(".fsSocialPostTo"),f=d.find(".fsSocialPostToInput"),h=(d.find(".fsSocialPostAvailablePerson"),"fsSocialPostToPlaceholder"),i="."+h;if(c.hasClass("fsSocialPostAddRecipients"));else{if(c.hasClass(k))return c.parent().remove(),d.find(".fsSocialPostAvailablePerson").each(function(){a(this).attr("data-pid")==c.next().val()&&a(this).parent().show()}),1==e.children("span").length&&a(i).show(),!1;e.find(i).hide(),f.show().focus()}}function z(b,c){a(c).html('<ul><li>Loading&hellip;<br><img src="images/loadingbar.gif"></li></ul>');var d=[];a(e).find(".fsSocialPostSelectedRecipient").find('input[name="selectedPersonIDs"]').each(function(){d.push(a(this).val())}),d=d.length>0?d.join(","):"";var f={success:function(b){a(c).find("ul").replaceWith(b)},data:{method:"getComposeMsgResults",filter:b,personsToOmit:d,rowStart:1}};a.ajax(a.extend(f,v))}function A(){var b=a(this),c=b.attr("data-pid"),d=b.parents("#fsComposeMessagePostForm"),e=d.find(".fsSocialPostTo"),f="fsSocialPostToPlaceholder",g="."+f,h="selectedPersonIDs",i=!1;return a(".fsSocialPostSelectedRecipient").find('input[name="selectedPersonIDs"]').each(function(){a(this).val()==c&&(i=!0)}),i||(e.find(g).hide(),e.children("span").last().after('<span class="fsSocialPostSelectedRecipient"><a href="javascript:void 0" title="Remove Person" class="'+k+'"></a><input type="hidden" name="'+h+'" value="'+c+'">'+b.text()+"</span>")),b.parent().hide(),!1}function B(){var e=a(this).parent().find(".pplName").attr(o),f="toolbar=no,location=no,directories=no,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=535,height=500",g=b.open("cf_directory/dirprofile.cfm?id="+e,"profileViewWindow",f);return g==c?alert("It appears that your browser has popup blocking enabled.\nPlease modify this setting to allow for full functionality."):g.focus(),!1}function C(){var b=a(this).parents(".composeMsgSearchForm").find("#composeMsgSearch").val(),c=a(this).parents("#composeMsgPicker").find("#composeMsgResults");return b.length>=1?(a(".composeMsgFilter a").each(function(){a(this).removeClass("on")}),z(b,c),void 0):(alert("please enter a name to search"),void 0)}function D(){var b=a(this).attr("data-filter"),c=a(this).attr("data-rowstart"),d=a(this).parent(),f=[];a(e).find(".fsSocialPostSelectedRecipient").find('input[name="selectedPersonIDs"]').each(function(){f.push(a(this).val())}),f=f.length>0?f.join(","):"",d.html('<img src="images/loadingbar.gif">');var g={success:function(a){d.replaceWith(a)},data:{method:"getComposeMsgResults",filter:b,personsToOmit:f,rowStart:c}};a.ajax(a.extend(g,v))}function E(){var b=a(this).html(),c=a(this).parents("#composeMsgPicker").find("#composeMsgResults");a(".composeMsgFilter a").each(function(){a(this).removeClass("on")}),a(this).addClass("on"),z(b,c)}function F(){return a(".fsSocialPostRecipientPicker").is(":visible")?a(".fsSocialPostAddRecipients").html('<span class="fsGlyphPlus"></span>Add'):a(".fsSocialPostAddRecipients").html("Close"),a(".fsSocialPostRecipientPicker").fadeToggle(function(){if(a(this).is(":visible")){var b=a(this).parents("#fsComposeMessagePostForm").find("#composeMsgResults");b.children("li").length<=1&&(z("all",b),a(".composeMsgFilter a").each(function(){a(this).removeClass("on"),"All"==a(this).html()&&a(this).addClass("on")}))}}),!1}function G(){a(".fsSocialPostMessage").each(function(){a(this).val("")}),a(".fsSocialPostSelectedRecipient").each(function(){a(this).remove()}),a(".fsSocialPostToPlaceholder").each(function(){a(this).show()}),a(".fsSocialPostAttachFile").each(function(){a(this).socialAttachFile("clear")}),a("#composeMsgResults").html('<ul><li id="moreRslts"><img src="images/loadingbar.gif"></li></ul>'),a(".fsSocialPostRecipientPicker").each(function(){a(this).is(":visible")&&(F(),a("#composeMsgSearch").val(""))}),a(".fsComposeMessagePostSpan").each(function(){a(this).is(":visible")&&(a(".fsComposeMessagePostSpan").fadeToggle(),a("#triggerNewMsg").html("New Message"))})}var d=a("#inboxViewport, #conversationViewport"),e=a("#fsComposeMessagePostForm"),g=(e.find(".fsSocialPostTo"),e.find(".fsSocialPostToInput")),i=(e.find(".fsSocialPostAvailablePerson"),"fsSocialPostToPlaceholder"),k="fsGlyphDarkGrayX",m="selectedPersonIDs",n="data-",o=n+"pid",q="?profileView=messages&groupDashboardView=messages",t=(b.History&&History.getState,b.History&&History.pushState,b.History&&History.replaceState),v=(b.History&&History.back,{url:"cf_social/endpoints/messaging.cfm",statusCode:{401:function(){document.location="userlogin.cfm"+document.location.search},403:function(){alert("You do not have permission to use this function")},400:function(){alert("Bad request")}},type:"post"}),w={focus:function(b,c){var d=a(this).parents("#fsComposeMessagePostForm"),e=d.find(".fsSocialPostToInput");return e.val(c.item.label),!1},source:function(b,c){var d=[];a(e).find(".fsSocialPostSelectedRecipient").find('input[name="selectedPersonIDs"]').each(function(){d.push(a(this).val())}),d=d.length>0?d.join(","):"";var f={dataType:"json",data:{method:"getComposeMsgResults",filter:b.term,returnType:"json",personsToOmit:d,rowStart:1},success:function(b){c(a.map(b,function(a){return{label:a.label,value:a.value}}))}};a.ajax(a.extend(f,v))},minLength:2,select:function(b,c){var d=c.item.value,e=!1,f=a(this).parents("#fsComposeMessagePostForm"),g=f.find(".fsSocialPostTo"),h=f.find(".fsSocialPostToInput"),j=(f.find(".fsSocialPostAvailablePerson"),"fsSocialPostToPlaceholder"),l="."+j;return a(".fsSocialPostSelectedRecipient").find('input[name="selectedPersonIDs"]').each(function(){a(this).val()==d&&(e=!0)}),e||(g.find(l).hide(),g.children("span").last().after('<span class="fsSocialPostSelectedRecipient"><a href="javascript:void 0" title="Remove Person" class="'+k+'"></a><input type="hidden" name="'+m+'" value="'+d+'">'+c.item.label+"</span>")),h.val("").focus(),!1}};d.on("click",".pplName",A).on("click",".composeMsgPersonLink",B).on("click","#triggerNewMsg",x).on("click","#composeMsgSubmitSearch",C).on("click","#moreRslts_link",D).on("click",".composeMsgFilter a",E).on("click",".fsSocialPostAddRecipients",F).on("click",".fsSocialPostTo",y),a("#composeMsgSearch").on("keydown",function(b){return 13==b.keyCode?(a(this).parents("#fsComposeMessagePostForm").find("#composeMsgSubmitSearch").trigger("click"),!1):13!==b.keyCode}),a("#fsActivityStreamSearchKeyword").on("keydown",function(b){return 13==b.keyCode?(a(this).parents("#fsActivityStreamSearch").submit(),!1):13!==b.keyCode}),d.find(".fsSocialPostAttachFile").socialAttachFile(),a(document).delegate(".sendMessageLink","click",function(){G();var b=a('<div id="fsSoc_composeMsg"></div>'),c=!0,d=a(this).attr("data-pid");return b.dialog({title:"Compose Message",width:675,height:500,modal:!0,resizable:!1,open:function(){var b={success:function(b){var c=a("#fsSoc_composeMsg");c.html(b),c.find("#composeMsgResults").on("click",".pplName",A),c.on("click",".composeMsgPersonLink",B).on("click","#composeMsgSubmitSearch",C).on("click","#moreRslts_link",D).on("click",".composeMsgFilter a",E).on("click",".fsSocialPostAddRecipients",F).on("click",".fsSocialPostTo",y),c.find(".fsSocialPostAttachFile").socialAttachFile(),c.find(".fsSocialPostToInput").autocomplete(w).blur(function(){var b=a(this),d=b.prev();b.hide(),d.hasClass(i)&&d.show(),c.find(".fsSocialPostToInput").val("").focus()}),c.find("#composeMsgSearch").on("keydown",function(b){return 13==b.keyCode?(a(this).parents("#fsComposeMessagePostForm").find("#composeMsgSubmitSearch").trigger("click"),!1):13!==b.keyCode})},data:{method:"getComposeMsgDialog",addToMsg:c,pIDs:d}};a.ajax(a.extend(b,v))},close:function(){a("#fsSoc_composeMsg").remove()}}),!1}),g.autocomplete(w).blur(function(){var b=a(this),c=b.prev();return b.hide(),c.hasClass(i)&&c.show(),g.val("").focus(),!1}),a("#fsSocialPostIFrameCmpMsg").load(function(){var b,c=a("#conversationViewport");FS.util.hideLoadingPrompt();try{var b=a(this).contents().find("body")}catch(d){return}if(b.find(".fsSocialError").length){var e=b.find(".fsSocialError").attr("data-error");return a.jGrowl("We had an error: "+e),this.src="javascript:;",void 0}if("success"==b.text()){if(a("#conversationList").trigger("loadNewMessages"),c.length&&!c.is(":hidden")){var f=c.find('input[name="conversationID"]').val();if(f.length>0){var g=a("#conversationList").find(".streamEntry[data-cid="+f+"]");t({scrollTop:0},"Messages",q),g.trigger("click")}}G(),a.jGrowl("Message was sent successfully"),this.src="javascript:;",1==a("#fsSoc_composeMsg").dialog("isOpen")&&a("#fsSoc_composeMsg").dialog("close")}}),a(document).on("click",".fsSocialPostSubmit",function(){FS.util.displayLoadingPrompt("Sending message")})}(jQuery,this);