$j(function(){function H(){var a=$j(this);if(!a.hasClass(i)){var b=a.prev(),c=b.val(),d=a.closest(q).attr(v);extraSettings={data:{method:"addComment",txt:c,eID:d},error:function(b){400==b.status?alert("Please enter a valid comment. Comments may not be blank or contain html."):alert("An error occurred while adding your comment. Please try again."),a.removeClass(i)},success:function(c){a.parent().before(c),a.removeClass(i),b.val("")}},c.length&&d.length&&(a.addClass(i),$j.ajax($j.extend(extraSettings,G)))}}function I(){var a=$j(this),b=a.text(),d=0;for(c.find(o).hide(),c.children("span").last().after('<span class="fsSocialPostSelectedRecipient"><a href="#" title="Remove Group" class="'+k+'"></a><input type="hidden" name="'+t+'" value="'+a.attr("data-gid")+'">'+a.text()+"</span>"),a.hide();d<C.length;d++)if(C[d].label===b){C[d].label="";break}return!1}function J(a,b){return b?e.hide():e.slideToggle(),"Add"!==a.text()||b?a.html('<span class="fsGlyphPlus"></span>Add'):a.html("Close"),!1}function K(){var a=$j(this).parent(),b="this activity entry",c={method:"deleteObject"},d={error:function(){alert("Error deleting "+b+". Please try again."),a.removeClass(h)},success:function(){if("comment"==c.objectType&&O(a.parent(),-1),a.is("li")){var b=a.parents(q);if(0==a.siblings().length)a=b;else{var d=b.find(".streamEntryAggregateCount");d.html(parseInt(d.html())-1),b.attr(v,b.attr(v).replace(c.eID+",",""))}}a.remove()}};return a.hasClass(r)?(c.eID=a.closest(q).attr(v),c.ts=a.attr(x),c.pID=a.attr(w),b="this comment",c.objectType="comment"):(c.eID=a.attr(v),c.objectType="event",c.eID.split(",").length>2&&(b="these "+(c.eID.split(",").length-1)+" activity entries")),confirm("Are you sure you want to permanently delete "+b+"?")&&(d.data=c,$j.ajax($j.extend(d,G)),a.addClass(h)),!1}function L(a){var b=Math.floor(((new Date).getTime()-new Date(a).getTime())/1e3);return 60>b?"less than a minute ago":120>b?"1 minute ago":3600>b?Math.floor(b/60)+" minutes ago":7200>b?"1 hour ago":86400>b?Math.floor(b/3600)+" hours ago":86461>b?"1 day ago":void 0}function M(){var b=$j.extend({data:{method:"loadNewActivity",pID:a.attr(u+"personid"),gID:a.attr(u+"groupid"),types:a.attr(z),ts:a.attr(x),hideGroupName:a.attr(y)},success:function(b){var j,k,c=$j(b),d=c.filter("div.streamEntry"),e=c.filter("div.commentList"),h="show ",i=c.filter("span.timestamp").text();for(k=0;k<D.length;k++)d=d.filter("["+v+"!="+D[k]+"]");D.length=0,f=f.filter(function(){return 0==d.filter("["+v+"="+$j(this).attr(v)+"]").length}),f=d.add(f),j=f.length,j?(h+=j+" new update"+(j>1?"s":""),g.text(h).show()):g.hide(),e.each(function(){var b=$j(this),c=a.children("div[data-eid="+$j(this).attr(v)+"]").find(".streamEntryHiddenComments"),d=a.children("div[data-eid="+$j(this).attr(v)+"]").find(".streamEntryComments"),e=defaultNumStreamCommentsToShow,f=b.children().length,g=f-e,h=b.find("div.streamEntryComment:lt("+g+")"),i=b.find("div.streamEntryComment:gt("+(g-1)+")");d.children().not(".streamEntryCommentAddEntry,").remove(),d.prepend(i),c.children().remove(),c.prepend(h),c.prev().children("span.streamEntryHiddenCount").text(g),f>e&&c.prev().show()}),i&&(a.attr(x,i),setTimeout(M,E)),F=!1,$j(window).one("mousemove",function(){F=!0})}},G);F?(delete b.statusCode,$j.ajax(b)):$j(window).one("mousemove",function(){F=!0,setTimeout(M,2e3)})}function N(){var b=$j(this),c={data:{method:"loadOlderActivity",pID:b.attr(u+"personid"),gID:b.attr(u+"groupid"),keywords:b.attr(u+"keywords"),displaymode:b.attr(u+"displaymode"),types:b.attr(z),ts:b.attr(u+"last-time"),hideGroupName:a.attr(y)},success:function(a){b.prevAll(".streamError,.streamInfo").remove(),b.replaceWith(a)}};$j.ajax($j.extend(c,G)),b.prop(A,!0).addClass(i)}function O(a,b){if(a.hasClass("streamEntryHiddenComments")){var c=a.find(".streamEntryComment:not(.streamEntryCommentAddEntry)").length-1,d=a.parent().find("span.streamEntryHiddenCount");c>defaultNumStreamCommentsToShow&&d.show();var e=Math.max(0,parseInt(d.text(),10)+b);d.text(e+""),0==e&&d.parent().hide()}}function P(){var b=$j(this).attr(w),c="toolbar=no,location=no,directories=no,status=no,menubar=yes,scrollbars=yes,resizable=yes,width=535,height=500",d=window.open("cf_directory/dirprofile.cfm?id="+b,"profileViewWindow",c);return void 0==d?alert("It appears that your browser has popup blocking enabled.\nPlease modify this setting to allow for full functionality."):d.focus(),!1}function Q(a){var g,b=$j(a.target),f=0;if(b.hasClass(k)){for(g=b.parent().text(),b.parent().remove(),e.find('[data-gid="'+b.next().val()+'"]').show(),1==c.children("span").length&&$j(o).show();f<C.length;f++)if(C[f].xLabel===g){C[f].label=C[f].xLabel;break}return!1}c.find(o).hide(),d.show().focus()}function R(){f.each(function(){a.children("div["+v+"="+$j(this).attr(v)+"]").remove()}),a.find(".streamError,.streamInfo").remove(),a.prepend(f),f=$j(),g.hide(),U()}function S(){var a=$j(this),b=a.find(".streamShowHideText");return a.next().slideToggle().find(s+"Input").focus(),b.text("Hide"==$j.trim(b.text())?"Show":"Hide"),!1}function T(){return $j(this).toggleClass("fsActivityExpandLinkOpen").parent().nextAll("ul").slideToggle(),!1}function U(){$j(q+"Date["+x+"]").each(function(){var a=$j(this),b=L(a.attr(x));b&&a.text(b),b&&"1 day ago"!==b||a.removeAttr(x)}),setTimeout(U,6e4)}var a=$j("#activityStream"),b=$j("#fsActivityStreamPostForm"),c=b.find(".fsSocialPostTo"),d=b.find(".fsSocialPostToInput"),e=b.find(".fsSocialPostAvailableRecipients"),f=$j(),g=a.prev(".fsSocialNewStreamEntries"),h="loadingBar",i="iconBtnWaiting",j="fsSocialPostFormCollapsed",k="fsGlyphDarkGrayX",m=".fsSocialPostAddRecipients",n="fsSocialPostToPlaceholder",o="."+n,p="streamEntry",q="."+p,r=p+"Comment",s="."+r,t="selectedGroupIDs",u="data-",v=u+"eid",w=u+"pid",x=u+"ts",y=u+"hide-group-name",z=u+"activity-types",A="disabled",B="32",C=[],D=[],E=15e3,F=!0,G={url:"cf_social/endpoints/activity.cfm",statusCode:{401:function(){document.location="userlogin.cfm"+document.location.search},403:function(){alert("You do not have permission to use this function")}},type:"post"};e.find("a").each(function(){var a=$j(this);C.push({label:a.text(),xLabel:a.text(),tagLink:a})}),$j("#activityUserFilter").change(function(){var a=$j(this);$j(".activityGroupFilter").hide().attr(A,!0),$j("#activityGroupFilterFor"+a.val()).attr(A,!1).show()}),$j("#fsSocialPostIFrame").load(function(){var c,d=a.attr("data-groupid"),e=a.attr(z),f=!1;FS.util.hideLoadingPrompt();try{if(c=$j(this).contents().find("body").children(),!c.length)return}catch(g){return}c.filter(".fsSocialError").each(function(){alert(this.innerHTML.replace(/\*/g,"\n"))}),c=c.not(".fsSocialError"),c.length&&(""==e||e==B?(a.find(".streamInfo,.streamError").remove(),""==d?c.prependTo(a).find("*").addClass("z1").end().addClass("z1"):(c.each(function(){var b=$j(this);b.attr("data-gid")==d&&(b.prependTo(a).find("*").addClass("z1").end().addClass("z1"),f=!0)}),f&&$j.jGrowl("Post successful")),c.each(function(){var a=$j(this).attr(v);a&&D.push(a)})):$j.jGrowl("Post successful"),J(b.find(m),!0),b.addClass(j),b.find("textarea").val(""),b.find(".fsSocialPostAttachFile").socialAttachFile("clear"),b.find(".fsSocialPostSelectedRecipient a").click()),this.src="javascript:;"}),a.on("click",".streamLoadMore",N).on("click",".profileLink",P).on("click",".fsGlyphGrayX",K).on("click",s+"AddButton",H).on("keyup",s+"Input",function(a){var b=$j(this);13===a.which?b.next().click():b.val().length>50&&b.height(75)}).on("click",s+"Count",S).on("click",".fsActivityExpandLink",T),c.click(Q),g.click(R),$j(m).click(function(){var a=$j(this);return J(a,!1),!1}),e.on("click",".fsSocialPostAvailableGroup",I),d.autocomplete({select:function(a,b){return b.item.tagLink.click(),d.val("").focus(),!1},source:function(a,b){b($j.ui.autocomplete.filter(C,a.term))}}).blur(function(){var a=$j(this),b=a.prev();a.hide(),b.hasClass(n)&&b.show()}).on("keydown",function(a){return 13!==a.keyCode}),a.hasClass("fsSocialSearchResults")||a.hasClass("fsNewActivityResults")||setTimeout(M,E),b.find("input[type=text],textarea").placeholder(),b.find(".fsSocialPostAttachFile").socialAttachFile(),b.find("textarea").focus(function(){$j(this).parent().parent().removeClass(j)}).on("keydown",function(a){return 9===a.keyCode?(c.click(),!1):void 0}),b.find(".fsSocialPostAddRecipients").on("keydown",function(a){return 9===a.keyCode&&a.shiftKey?(c.click(),!1):void 0}),setTimeout(U,6e4)});