var g_fdelMsg=0;var g_rgWin=new Array();var g_iWns=0;var g_rgsSigrEM;var g_rgsSigrCN;var g_rgsIss;var g_rgiSigCa;var g_rgsSigSt;var g_rgsSigDt;var g_iSig=0;var g_iMxHtSl;var g_oDlgSDtl=0;var g_iSDDW=500;var g_iSDDH=300;if(!g_fModuleLoaded)var g_fModuleLoaded={};if(!g_fModuleLoaded["freadmsg.js".toLowerCase()])(function(){Type.createNamespace("Owa.Pages");Owa.Pages.ReadMessagePage=function Owa$Pages$ReadMessagePage(oElement){Owa.Pages.ReadMessagePage.constructBase(this,[oElement,false])};var _oPrototype=Owa.Pages.ReadMessagePage.prototype;_oPrototype.initialize=function Owa$Pages$ReadMessagePage$initialize(){Owa.Pages.ReadMessagePage.callBase(this,"initialize");var oWindow=Owa.Dom.Window.get_Current();oWindow.attachEvent("beforeprint",befPrn);oWindow.attachEvent("afterprint",aftPrn);Owa.Components.ToolbarCollection.get_Current().addToolbars(["tblARTB"],this.get_ActionTable());safeResizeWells();initMmCtl();if(g_oMmBdy){initSIT();initMmAtt();cTBS(true);ldMsgMm(getIdQS(),pstMmDec)}initIM();var fIsBuddy=0;var oSpan=$("spnFrom");if(oSpan){fIsBuddy=isBuddy(gtRcpIM(oSpan))}enbIMBtns(this.get_SubPage(),g_fIsIMEnab,fIsBuddy,a_fPhsh);addPerfMarker("ReadMessage.Init.End");if(isOfClss(a_sT,IT_SHR)){this.get_ActionTable().getAction("forward").disable()}};_oPrototype.dispose=function Owa$Pages$ReadMessagePage$dispose(){hdPrgrsInd();if(isDf(typeof(g_oDlgSndEm))&&g_oDlgSndEm){g_oDlgSndEm.hide()}if(g_oDlgSDtl){g_oDlgSDtl.hide()}dispReadWells();if(g_oDlgMDtl){g_oDlgMDtl.dispose()}dispIM();Owa.Pages.ReadMessagePage.callBase(this,"dispose")};_oPrototype._initializeHotkeys=function Owa$Components$ReadMessagePage$_initializeHotkeys(){Owa.Pages.ReadMessagePage.callBase(this,"_initializeHotkeys");this.addHk("Ctrl+188","previous");this.addHk("Ctrl+190","next");this.addHk(L_HkDlt,"delete");if(!(isJnkFld()||a_fPhsh)){if(!a_fReplyRestricted){this.addHk(L_HkRpl,"reply")}if(!a_fReplyAllRestricted){this.addHk(L_HkRplAll,"replyall")}this.addHk(L_HkCht,"chat")}if((a_iT!=a_IT_APV_RQ)&&!a_fForwardRestricted)this.addHk(L_HkFwd,"forward")};_oPrototype._onUserAction=function Owa$Pages$ReadMessagePage$_onUserAction(sAction,oContext){switch(sAction){case"messagedetails":ldMDtl();break;case"delete":if(!a_fCD||!isDf(typeof(a_sId))||a_fSmEmb)return;delMsg(a_fInDelItms||a_fP);break;case"previous":getItm(a_sId,window.name,0);break;case"next":getItm(a_sId,window.name,1);break;case"replyall":smRepFwItm("ReplyAll");break;case"reply":smRepFwItm("Reply");break;case"sendAgain":repFwItm(a_sT,"SendAgain",a_fPrv);break;case"forward":smRepFwItm("Forward");break;case"chat":nwChtSsnFrm();break;case"print":if(g_fDrty)alrt(L_SavePrt,null,Owa.BUTTON_DIALOG_ICON.WARNING,L_SavePrtTtl);else if(g_oMmBdy)window.print();else opnPrntFrm(a_sT);break;case"ntjnk":var oSpnFrom=wda("spnFrom");shwNtJnkDlg(this.get_SubPage(),a_sId,0,(oSpnFrom!=null?oSpnFrom.title:null));break;case"crrul":opnEcpNewRul(this.get_SubPage(),getIdQS());break;case"approve":procApv(APV_SND,APV_APP);break;case"reject":procApv(APV_SND,APV_REJ);break;case"apvedrsp":procApv(APV_EDT,getApv(oContext));break;case"apvsndrsp":procApv(APV_SND,getApv(oContext));break;default:Owa.Pages.ReadMessagePage.callBase(this,"_onUserAction",[sAction,oContext]);break}};_oPrototype._onNewItem=function Owa$Pages$ReadMessagePage$_onNewItem(){if(isOfClss(a_sT,IT_SMS)){newSms(this)}else{newMail(false,this)}};Owa.Pages.ReadMessagePage.createClass("Owa.Pages.ReadMessagePage",Owa.Pages.FormSubPage)})();g_fModuleLoaded["freadmsg.js".toLowerCase()]=1;function resizeWells(){var rgLabelIds=new Array("divSentL","divToL","divCcL","divBccL");if(wda("divSign")&&wda("divSign").style.display!="none")rgLabelIds.push("divSignL");if(wda("divWellCategories").style.display!="none")rgLabelIds.push("divCategoriesL");if(wda("divWellAttach")&&wda("divWellAttach").style.display!="none")rgLabelIds.push("divAttachL");Owa.Layout.setElementWidthsToLargest(rgLabelIds)}function getApv(o){while(o&&!o.hasCssClass("subMenu")){o=o.get_ParentElement()}if(o.get_Id().indexOf("approve")!=-1)return APV_APP;if(o.get_Id().indexOf("reject")!=-1)return APV_REJ}var g_fApv=0;function procApv(sOp,sVt){if(isDf(typeof(g_fApv))&&g_fApv)return;if(sVt==APV_APP&&a_sLocApproval!=""){sVt=a_sLocApproval}else if(sVt==APV_REJ&&a_sLocReject!=""){sVt=a_sLocReject}var oC=new Object();oC.sOp=sOp;oC.sVt=sVt;var oR=new oeReq("ReadMessage",sOp,oC,cbProcApv);oR.add("Id",a_sId);oR.add("CK",a_sCK);oR.add("fId",a_sFId);oR.add("Vt",sVt);g_fApv=1;oR.send()}function cbProcApv(oR){if(isDf(typeof(g_fApv))&&g_fApv)g_fApv=0;if(!cbOeh(oR))return;var oC=oR.oCtx;if(oC.sOp==APV_EDT){var oDivResponse=Owa.Dom.Document.get_Current().createElement("div");oDivResponse.set_InnerHtml(oR.sBody);if(oDivResponse.getDescendantById("itmId")){var sId=oDivResponse.getDescendantById("itmId").get_TextContent();var sUrl="?ae=Item&t=IPM.Note&a=New&id="+urlEnc(sId);if(a_fPrv){opnWin(sUrl)}else{try{var oOpenerController=Owa.Components.SubPageControllerFactory.get_CurrentWindowSubPageController().get_OpenerController();if(oOpenerController){oOpenerController.invokeFunction("openItm",[sUrl])}}catch(e){opnWin(sUrl)}}}else{alrt(L_ErrApvOpRsp)}}self.close();rfMailVw(a_fPrv,true)}function onMmActEnd(){var sA=event.getAttribute("action").toLowerCase();if(sA=="decodemime")onDecEnd();else if(sA=="load")onLdEnd()}function onMmExCtBlk(){replaceOrInsertInfobarMessage(a_sWBIB,"divWBIB")}function rldExCt(){g_oMmBdy.reloadExternalContent();checkRemoveInfobarMessage("divWBIB");if(!a_fEmb&&!a_fP)savRMsg("ReadMessage","AlWbBcn",1,a_fPrv)}function smRepFwItm(sC){if(g_oMmBdy){attchEvt(window,"beforeunload",onFWCld);var nWin=repFwItm(a_sT,sC,1);if(nWin){g_rgWin[g_iWns]=nWin;g_iWns++}}else{repFwItm(a_sT,sC,a_fPrv)}}function onFWCld(){if(!canCls())return L_RFCnA}function canCls(){for(var i=0;i<g_rgWin.length;i++){if(g_rgWin[i]&&!g_rgWin[i].closed&&g_rgWin[i].g_fDataTran)return false}return true}function onLdEnd(){if(!event.getAttribute("hasWinmailTnefAttachment"))return;replaceOrInsertInfobarMessage(L_UkAtt)}function isDecSigErr(iErr){return iErr==0x80091002||iErr==0x800CCEF7||iErr==0x80091007}function onDecEnd(){var iErr=hres(getEvErr());var fHashErr=(iErr==0x80091007);var fRvkErr=(iErr==0x80092010);hdPrgrsInd();cTBS(false);if(g_oMmBdy.encrypted)shEnI();g_rgiSigCa=new Array();g_rgsSigSt=new Array();g_rgsSigDt=new Array();if(iErr!=0){var iExtErr=getEvExtErr();if(!fRvkErr&&!(fHashErr&&(iExtErr&0x00000100))){if(a_fOpSigOrEn){var divErr=wda("divErr");showSMErr(divErr,iErr,CTS_LD,iExtErr);if(g_oMmBdy.Signed&&g_oMmBdy.encrypted)divErr.all["tdMsg"].innerHTML+=("<br>"+htmlEnc(L_CtVlSg))}if(g_oMmBdy.Signed&&isDecSigErr(iErr)){shwSigRes(new Array(iErr.toString()));if(!a_fOpSigOrEn)rdAW()}g_MMRdy_Stat&=MMRdy_Frm;readFmUpdCmp(window);return}}rdAW();if(!fHashErr&&g_oMmBdy.Signed)valCert();g_MMRdy_Stat&=MMRdy_Frm;readFmUpdCmp(window)}function rdAW(){var oMI=new MsgInfo(a_fJoP,a_fEmb,a_fRp,a_iEmbD);var oAP=new AttPlcy();var rgAIs=getAIs(g_oMmBdy.attachments,oAP,oMI,AWT_RO,a_fEnIL);if(rgAIs)rdAttWl(rgAIs,AWT_RO,oMI,oAP,wda("divAtch"),true)}function pstMmDec(){if(g_oMmBdy.DOM.readyState!="complete"){setTimeout(pstMmDec,100);return}shMmBdy();safeResizeBodies();g_MMRdy_Stat&=MMRdy_Bdy;readFmUpdCmp(window)}function cTBS(f){var rgBtns=document.getElementsByName("lnkB");for(var i=0;i<rgBtns.length;++i){var oB=rgBtns[i];switch(oB.id){case"reply":case"replyall":case"crrul":case"forward":case"flag":case"cat":case"messagedetails":case"print":if(f)oB._st=(cntnCls(oB,"btnDa")?0:1);if(oB._st)enblB(oB.id,f);break}}}function shEnI(){var spEn=document.getElementById("spEn");if(spEn)showEm(spEn)}var g_iVCTmId=0;function upUIBVC(){g_iVCTmId=0;shwSiLn();shwSiVaEs()}function valCert(){if(!g_oMmBdy)return;g_iVCTmId=setTimeout(upUIBVC,g_iPrgIndDly);var certs=g_oMmBdy.signatures.toArray();var chains=g_oMmBdy.certificateChains.toArray();var oR=new oeReq("SMime","ValidateCerts",0,cbValCert,POST);oR.addRg("certs",certs);oR.addRg("chains",chains);oR.add("isSend",0);oR.send()}function cbValCert(oR){if(!cbOeh(oR))return;if(g_iVCTmId)clearTimeout(g_iVCTmId);else HdSiVaEs();chkSiVaRes(oR)}function shwSiLn(){var siP=wda("divSign");if(siP){showEm(siP);safeResizeWells();safeResizeBodies()}}function shwSiVaEs(){var siP=wda("spSigPro");if(siP)showEm(siP)}function HdSiVaEs(){var siP=wda("spSigPro");if(siP)hideEm(siP)}function rdSiVaRes(){var siR=wda("spnSigRes");if(siR){var sH="";var iErr=-1;for(var i=g_iSig-1;i>=0;i--){if(g_rgiSigCa[i]!=0&&g_rgiSigCa[i]!=1){iErr=i;break}}if(iErr!=-1){sH+="<span id=spSRI><a href=\"#\" onclick=\"shwSDtlDlg("+i+");\">";sH+="<img alt=\""+htmlEnc(g_rgsSigSt[iErr])+"\" src=\""+htmlEnc(getThmF("siginvalid.gif"))+"\">";sH+="</a></span>";sH+="<span id=spSiErrInLi title=\""+htmlEnc(g_rgsSigSt[iErr])+"\">";sH+=htmlEnc(L_SgVldF);sH+="</span>";sH+="<span id=spSMI>";sH+=g_sDE;sH+=htmlEnc(L_OpPT);sH+="<a id=signLnk href=\"#\" onclick=\"shwSDtlDlg("+iErr+");\">"+htmlEnc(L_MrInf)+"</A>";sH+=g_sDE;sH+=htmlEnc(L_CdPT);sH+="</span>"}else{var fFirst=1;var oDup={};for(var i=g_iSig-1;i>=0;i--){if(oDup[g_rgsSigrEM[i]])continue;oDup[g_rgsSigrEM[i]]=1;if(fFirst){sH+="<span id=spSRI><a href=\"#\" onclick=\"shwSDtlDlg("+i+");\">";fFirst=0}else sH+="; <span id=spSRI><a href=\"#\" onclick=\"shwSDtlDlg("+i+");\">";var sImgSrc="";switch(g_rgiSigCa[i]){case 0:sImgSrc=getThmF("sigvalid.gif");break;case 1:sImgSrc=getThmF("sigwarning.gif");break}sH+="<img alt=\""+htmlEnc(g_rgsSigSt[i])+"\" tabindex=\"-1\" src=\""+htmlEnc(sImgSrc)+"\">";sH+="</a></span>";sH+="<span id=spSigner title=\""+htmlEnc(g_rgsSigrCN[i])+"\" >";sH+=htmlEnc(g_rgsSigrEM[i]);sH+="</span>";sH+="<span id=spSMI>";sH+=g_sDE;sH+=htmlEnc(L_OpPT);sH+="<a id=signLnk href=\"#\" tabindex=\"-1\" onclick=\"shwSDtlDlg("+i+");\">"+htmlEnc(L_MrInf)+"</A>";sH+=g_sDE;sH+=htmlEnc(L_CdPT);sH+="</span>"}}siR.innerHTML=sH;initSl();showEm(siR)}}var SIGN_ICON_HT=16;function initSl(){var spnSigRes=wda("spnSigRes");if(!spnSigRes)return;var oS=spnSigRes.currentStyle;g_iMxHtSl=(2*getInt("0"+oS.padding))+(2*getInt("0"+oS.borderWidth))+Math.max((2*spnSigRes.scrollHeight),(2*SIGN_ICON_HT))+2;rszSl()}function rszSl(){var spnSigRes=wda("spnSigRes");if(!spnSigRes||!g_iSig)return;spnSigRes.style.pixelHeight=Math.min(spnSigRes.scrollHeight,g_iMxHtSl)}function chkSiVaRes(oR){var divR=getEm("div");ac(divR);divR.innerHTML=oR.sBody;var pErrs=divR.all["res"];var pEmls=divR.all["eml"];var pCns=divR.all["cn"];var pIsses=divR.all["issuer"];var rgErr=new Array();var rgEml=new Array();var rgCn=new Array();var rgIss=new Array();if(!isRg(pErrs)){rgErr[0]=pErrs.innerText;rgEml[0]=pEmls.innerText;rgCn[0]=pCns.innerText;rgIss[0]=pIsses.innerText}else{for(var i=0;i<pErrs.length;i++){rgErr[i]=pErrs[i].innerText;rgEml[i]=pEmls[i].innerText;rgCn[i]=pCns[i].innerText;rgIss[i]=pIsses[i].innerText}}rn(divR);shwSigRes(rgErr,rgEml,rgCn,rgIss)}function shwSigRes(rgErr,rgEml,rgCn,rgIss){g_rgsSigrEM=new Array();g_rgsSigrCN=new Array();g_rgsIss=new Array();g_iSig=rgErr.length;for(var i=0;i<g_iSig;i++){g_rgsSigrEM[i]=rgEml?rgEml[i]:"";g_rgsSigrCN[i]=rgCn?rgCn[i]:"";g_rgsIss[i]=rgIss?rgIss[i]:"";var err=rgErr[i];g_rgiSigCa[i]=gtSgnErCt(parseInt(err));switch(g_rgiSigCa[i]){case 0:g_rgsSigSt[i]=L_SigStP;break;case 1:g_rgsSigSt[i]=L_SigStW;break;case 2:g_rgsSigSt[i]=L_SigStF;break;default:g_rgsSigSt[i]=L_SigStF;break}g_rgsSigDt[i]=mapETS(parseInt(err),CTS_SV,2)}shwSiLn();rdSiVaRes()}function updSDlgInfo(idx){var tdSsSs=wda("tdSsSs");if(tdSsSs)tdSsSs.innerText=g_rgsSigSt[idx];var tdSsEs=wda("tdSsEs");if(tdSsEs)tdSsEs.innerText=g_rgsSigDt[idx];var img;img=wda("imgDVS");if(img)hideEm(img);img=wda("imgDWS");if(img)hideEm(img);img=wda("imgDIVS");if(img)hideEm(img);switch(g_rgiSigCa[idx]){case 0:img=wda("imgDVS");break;case 1:img=wda("imgDWS");break;case 2:img=wda("imgDIVS");break;default:img=wda("imgDIVS");break}if(img)showEm(img);if(g_oMmBdy.encrypted){var sigDlgEn=wda("trSigDlgEn");if(sigDlgEn)showEm(sigDlgEn)}if(g_rgiSigCa[idx]!=2){var subj=getSSubj(g_oMmBdy);var from=getSSdr(g_oMmBdy);var dIn=wda("siInBdy");if(dIn)showEm(dIn);var dErr=wda("siErrBdy");if(dErr)hideEm(dErr);var tdSubj=wda("tdSubj");if(tdSubj)tdSubj.innerText=subj;var tdFrom=wda("tdFrom");if(tdFrom)tdFrom.innerText=from;var tdSigBy=wda("tdSigBy");if(tdSigBy)tdSigBy.innerText=g_rgsSigrEM[idx];var tdIssBy=wda("tdIssBy");if(tdIssBy)tdIssBy.innerText=g_rgsIss[idx]}else{var dIn=wda("siInBdy");if(dIn)hideEm(dIn);var dErr=wda("siErrBdy");if(dErr)showEm(dErr)}}function shwSDtlDlg(idx){var divSDtl=wda("divSDtl");if(divSDtl){updSDlgInfo(idx);g_oDlgSDtl=new BtnDlg("divSDtlDlg",divSDtl.innerHTML,L_SDtl,new Array(L_OK),g_iSDDW,null,cbClsSDtlDlg);g_oDlgSDtl.show()}}function cbClsSDtlDlg(){g_oDlgSDtl=0}function befPrn(){if(!g_oMmBdy)return;var dvPrn=wda("dvPrnMsgBdy");if(dvPrn){showEm(dvPrn);dvPrn.innerHTML=g_oMmBdy.DOM.body.innerHTML;hideEm(g_oMmBdy)}var dvAtch=wda("divAtch");if(dvAtch)dvAtch.className="awPr";var spSigRes=wda("spnSigRes");if(spSigRes)spSigRes.className="slPr";var spSMI=wda("spSMI");var i;if(spSMI)if(isRg(spSMI))for(i=0;i<spSMI.length;i++)hideEm(spSMI[i]);else hideEm(spSMI);var tblTB=wda("tblTB");if(tblTB)hideEm(tblTB)}function aftPrn(){if(!g_oMmBdy)return;var dvPrn=wda("dvPrnMsgBdy");if(dvPrn){hideEm(dvPrn);dvPrn.innerHTML="";showEm(g_oMmBdy)}var dvAtch=wda("divAtch");if(dvAtch)dvAtch.className="awRO";var spSigRes=wda("spnSigRes");if(spSigRes)spSigRes.className="sl";var spSMI=wda("spSMI");var i;if(spSMI)if(isRg(spSMI))for(i=0;i<spSMI.length;i++)showEm(spSMI[i]);else showEm(spSMI);var tblTB=wda("tblTB");if(tblTB)showEm(tblTB)}function getSigTxt(sCn,sEm){if(sEm)return sEm;else if(sCn)return sCn;else return""}function getSSubj(oBody){var subj;try{subj=oBody.headers["Subject"]}catch(e){subj=""}return subj}function getSSdr(oBody){var sdrHdl;var sdr;try{sdrHdl=oBody.headers["From"];sdr=sdrHdl.toString("%1").toString("%1&nbsp;"+g_sDE+"[%2"+g_sDE+"]")}catch(e){sdr=""}return sdr}function onLocalLink(sId){var oDoc=$("ifBdy").get_ContentWindow().get_Document();var oEl=oDoc.getElementsByName(sId);if(oEl&&oEl.length>0){oEl[0].scrollIntoView(true)}else{oEl=oDoc.getElementById(sId);if(oEl){oEl.scrollIntoView(true)}}}stJS("freadmsg.js");